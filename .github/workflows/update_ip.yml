name: ğŸš€ æ›´æ–°èŠ‚ç‚¹ IP

on:
  workflow_dispatch:
    inputs:
      new_ip:
        description: 'è¯·è¾“å…¥æ–°çš„ Server IP åœ°å€'
        required: true
        default: '10.1.0.54'

jobs:
  update-yaml:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: å®‰è£…ä¾èµ–
        run: pip install ruamel.yaml

      - name: ä¿®æ”¹ YAML æ–‡ä»¶
        shell: python
        env:
          NEW_IP: ${{ inputs.new_ip }}
        run: |
          import os
          from ruamel.yaml import YAML

          # åˆå§‹åŒ– YAML å¤„ç†å™¨ï¼ˆä½¿ç”¨ ruamel.yaml ä»¥ä¿ç•™æ³¨é‡Šå’Œæ ¼å¼ï¼‰
          yaml = YAML()
          yaml.preserve_quotes = True
          yaml.width = 4096 # é˜²æ­¢é•¿è¡ŒæŠ˜è¡Œ

          file_path = 'ComSenyou.yaml'
          new_ip = os.environ['NEW_IP']

          # è¯»å–æ–‡ä»¶
          try:
              with open(file_path, 'r', encoding='utf-8') as f:
                  data = yaml.load(f)

              # æŸ¥æ‰¾å¹¶ä¿®æ”¹æŒ‡å®šèŠ‚ç‚¹çš„ IP
              updated_count = 0
              if 'proxies' in data:
                  for proxy in data['proxies']:
                      # é”å®šé‚£ä¸¤ä¸ªç‰¹å®šçš„èŠ‚ç‚¹åç§°
                      if proxy['name'] in ['ğŸ¤£ GoogleOneVpnSocksCom', 'ğŸ¤¦â€â™€ï¸ GoogleOneVpnHttpCom']:
                          print(f"Updating {proxy['name']} from {proxy.get('server')} to {new_ip}")
                          proxy['server'] = new_ip
                          updated_count += 1
              
              if updated_count > 0:
                  # å†™å›æ–‡ä»¶
                  with open(file_path, 'w', encoding='utf-8') as f:
                      yaml.dump(data, f)
                  print(f"âœ… æˆåŠŸæ›´æ–°äº† {updated_count} ä¸ªèŠ‚ç‚¹")
              else:
                  print("âš ï¸ æœªæ‰¾åˆ°æŒ‡å®šçš„èŠ‚ç‚¹åç§°ï¼Œè¯·æ£€æŸ¥ yaml æ–‡ä»¶")
                  exit(1) # æŠ¥é”™é€€å‡ºï¼Œä¸æäº¤

          except Exception as e:
              print(f"âŒ å‘ç”Ÿé”™è¯¯: {e}")
              exit(1)

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "actions@github.com"
          git add ComSenyou.yaml
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨ï¼Œæœ‰å˜åŠ¨æ‰æäº¤
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
          else
            git commit -m "è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹ IP ä¸º: ${{ inputs.new_ip }}"
            git push
            echo "ğŸ‰ æ¨é€æˆåŠŸï¼"
          fi
